<?php
require_once 'config.php';
check_auth();




require_once 'config.php';
require_once 'auth.php';
checkLogin();

// إحصائيات عامة
$stats = [];

// عدد السجلات في كل جدول
$tables = ['patients', 'doctors', 'nurses', 'appointments', 'pharmacies'];
foreach ($tables as $table) {
    $stmt = $pdo->query("SELECT COUNT(*) as count FROM $table");
    $stats[$table] = $stmt->fetch()['count'];
}

// إحصائيات المواعيد
$appointmentStats = $pdo->query("
    SELECT 
        COUNT(*) as total,
        SUM(CASE WHEN status = 'مؤكد' THEN 1 ELSE 0 END) as confirmed,
        SUM(CASE WHEN status = 'ملغي' THEN 1 ELSE 0 END) as cancelled,
        DATE(appointment_date) as date
    FROM appointments 
    GROUP BY DATE(appointment_date)
    ORDER BY date DESC
    LIMIT 30
")->fetchAll();
?>

<!-- عرض الرسوم البيانية باستخدام Chart.js -->
<canvas id="appointmentsChart"></canvas>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('appointmentsChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: <?php echo json_encode(array_column($appointmentStats, 'date')); ?>,
        datasets: [{
            label: 'المواعيد المؤكدة',
            data: <?php echo json_encode(array_column($appointmentStats, 'confirmed')); ?>,
            borderColor: 'green'
        }]
    }
});
</script>





// جلب الإحصائيات
$stmt = $pdo->query("SELECT COUNT(*) as total FROM patients");
$total_patients = $stmt->fetch()['total'];

$stmt = $pdo->query("SELECT COUNT(*) as total FROM doctors");
$total_doctors = $stmt->fetch()['total'];

$stmt = $pdo->query("SELECT COUNT(*) as total FROM appointments WHERE status = 'مؤكد'");
$total_appointments = $stmt->fetch()['total'];

// يمكن إضافة المزيد من الإحصائيات
?>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>التقارير والإحصائيات</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <?php include 'navbar.php'; ?>
    <div class="container mt-4">
        <h2>التقارير والإحصائيات</h2>
        
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card text-white bg-primary mb-3">
                    <div class="card-header">المرضى</div>
                    <div class="card-body">
                        <h5 class="card-title"><?php echo $total_patients; ?></h5>
                        <p class="card-text">إجمالي المرضى المسجلين</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success mb-3">
                    <div class="card-header">الأطباء</div>
                    <div class="card-body">
                        <h5 class="card-title"><?php echo $total_doctors; ?></h5>
                        <p class="card-text">إجمالي الأطباء</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-info mb-3">
                    <div class="card-header">المواعيد</div>
                    <div class="card-body">
                        <h5 class="card-title"><?php echo $total_appointments; ?></h5>
                        <p class="card-text">إجمالي المواعيد المؤكدة</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <canvas id="appointmentsChart"></canvas>
            </div>
        </div>
    </div>
    
    <script>
    // مثال على رسم بياني باستخدام Chart.js
    const ctx = document.getElementById('appointmentsChart').getContext('2d');
    const myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['المرضى', 'الأطباء', 'المواعيد'],
            datasets: [{
                label: 'الإحصائيات',
                data: [<?php echo $total_patients; ?>, <?php echo $total_doctors; ?>, <?php echo $total_appointments; ?>],
                backgroundColor: ['#007bff', '#28a745', '#17a2b8']
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    </script>
</body>
</html>
