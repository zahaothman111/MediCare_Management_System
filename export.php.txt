<?php
require_once 'config.php';
require_once 'auth.php';

if (!hasPermission('admin')) {
    die('غير مصرح لك');
}

$table = $_GET['table'];
$filename = $table . '_' . date('Y-m-d') . '.xls';

header("Content-Type: application/vnd.ms-excel");
header("Content-Disposition: attachment; filename=\"$filename\"");

$stmt = $pdo->query("SELECT * FROM $table");
$rows = $stmt->fetchAll(PDO::FETCH_ASSOC);

echo "<table border='1'>";
// رأس الجدول
if (!empty($rows)) {
    echo "<tr>";
    foreach(array_keys($rows[0]) as $column) {
        echo "<th>" . htmlspecialchars($column) . "</th>";
    }
    echo "</tr>";
    
    // البيانات
    foreach($rows as $row) {
        echo "<tr>";
        foreach($row as $cell) {
            echo "<td>" . htmlspecialchars($cell) . "</td>";
        }
        echo "</tr>";
    }
}
echo "</table>";
?>
